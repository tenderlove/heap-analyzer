<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Heap Information</title>
  <style>
  .chart {
    float: left;
    width: 600px;
    height: 400px;
  }
  .top-buffer { margin-top:20px; }
  </style>
  <link rel="stylesheet" type="text/css" href="http://w2ui.com/src/w2ui-1.4.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.2/handlebars.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="http://w2ui.com/src/w2ui-1.4.min.js"></script>
</head>
<body>

<div class="container">
  <h1>Not Very Good MRI Heap Analyzer (<a href="https://github.com/tenderlove/heap-analyzer">Fork Me</a>)</h1>

  <div class="row">
    <div class="col-sm-12 form-inline">
      <div class="form-group">
        <label for="heap">Heap Dump JSON:</label>
        <input type="file" id="file" name="file" />
      </div>
      <button class="readButton btn btn-default">Submit</button>
    </div>
  </div>

  <div id="instructions" class="row top-buffer">
    <div class="col-sm-12 form-inline">
      Getting a heap dump of your Rails application just after boot:
      <pre>$ echo "require 'objspace'; ObjectSpace.trace_object_allocations_start" &gt; x.rb
$ RAILS_ENV=production ruby -I. -rx -e'require "config/environment"; GC.start; puts ObjectSpace.dump_all.path'</pre>
      This will print a file name that contains JSON representing your heap.  Upload that file.
    </div>
  </div>

  <div class="row top-buffer">
    <div class="col-sm-6">
      <div id="type-info" class="chart"></div>
    </div>
    <div class="col-sm-6">
      <div id="generation-info" class="chart"></div>
    </div>
  </div>
  <div class="row">
    <div id="obj-list" class="col-sm-12" style="height: 450px">
    </div>
  </div>
</div>

<script>

  var objects = [];
  var objIndex = {};
  var columns = [
    { field: 'address', caption: 'Address', size: '10%', hidden: true },
    { field: 'type', caption: 'Type', size: '10%' },
    { field: 'value', caption: 'Value', size: '30%' },
    { field: 'memsize', caption: 'Memsize', size: '10%', sortable: true },
    { field: 'generation', caption: 'Generation', size: '100px', sortable: true },
    { field: 'loc', caption: 'Location', size: '30%' },
    { field: 'file', caption: 'File', size: '30%', hidden: true },
    { field: 'line', caption: 'Line', size: '50px', hidden: true },
    { field: 'bs', caption: 'Bytesize', size: '100px', hidden: true },
    { field: 'class', caption: 'Class', size: '100px', hidden: true },
    { field: 'embedded', caption: 'Embedded', size: '50px', hidden: true },
    { field: 'flags', caption: 'Flags', size: '100px', hidden: true },
    { field: 'method', caption: 'Method', size: '200px', hidden: true }
  ];

  function truncStr(str) {
    if (str) {
      return str.substring(0, 30);
    } else {
      return str;
    }
  };

  function allocInfo(file, line) {
    if (file && line) {
      return file.substring(file.length - 30) + ":" + line;
    } else {
      return '';
    }
  };

  function objectsByType(objs) {
    var data = {};
    objs.forEach(function(obj) {
        if (obj.type) {
          if (!data[obj.type]) {
            data[obj.type] = [];
          }
          data[obj.type].push(obj);
        }
    });
    return data;
  }

  function objectsByGeneration(objs) {
    var data = {};
    objs.forEach(function(obj) {
        if (obj.generation) {
          if (!data[obj.generation]) {
            data[obj.generation] = [];
          }
          data[obj.generation].push(obj);
        }
    });
    return data;
  }

  function plotTypes(container, typeInfo) {
    // Build the chart
    container.highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Objects by Type'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                    style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                    }
                }
            }
        },
        series: [{
            name: "Type",
            data: Object.keys(typeInfo).map(function(key) {
               return { name: key, y: typeInfo[key].length, objs: typeInfo[key] };
            }),
            point: {
              events: {
                click: function(event) { showTable(this.objs); }
              }
            }
        }]
    });
  }

  function showTable(objs) {
    var records = objs.map(function(obj) {
      obj.value = truncStr(obj.value);
      obj.loc = allocInfo(obj.file, obj.line);
      obj.recid = obj.address;
      return obj;
    });
    if (w2ui.hasOwnProperty('Objects')) {
      w2ui['Objects'].destroy();
    };
    $('#obj-list').w2grid({
        name   : 'Objects',
        columns: columns,
        show: { toolbar: true },
        records: records,
        onExpand: parentsGridToggle,
        onCollapse: parentsGridToggle,
        onRefresh: function(event){
          columns = this.columns;
        }
    });
    w2ui['Objects'].sort('memsize', 'desc');
  };

  function parentsGridToggle(event) {
    if (w2ui.hasOwnProperty('subgrid-' + event.recid)) {
      w2ui['subgrid-' + event.recid].destroy();
    };
    var address = objects[objIndex[event.recid]].address;
    var parents = objects.filter(function(obj, ind) {
      return obj.references && obj.references.indexOf(address) >= 0;
    });

    var records = parents.map(function(obj) {
      obj.value = truncStr(obj.value);
      obj.loc = allocInfo(obj.file, obj.line);
      obj.recid = obj.address;
      return obj;
    });

    $('#'+ event.box_id).css({ margin: '0px', padding: '0px', width: '100%' }).animate({ height: '205px' }, 100);
    setTimeout(function () {
        $('#'+ event.box_id).w2grid({
            name: 'subgrid-' + event.recid,
            show: { columnHeaders: false },
            fixedBody: true,
            columns: columns,
            records: records,
            onExpand: parentsGridToggle
        });
        w2ui['subgrid-' + event.recid].resize();
        w2ui['subgrid-' + event.recid].sort('memsize', 'desc');
    }, 300);
  };

  function plotGeneration(container, genInfo) {
    var categories = Object.keys(genInfo).sort(function(a, b) { return a - b; });

    container.highcharts({
        title: {
            text: 'Allocations Per Generation',
            x: -20 //center
        },
        xAxis: {
            categories: categories
        },
        yAxis: {
            title: {
                text: 'Number of Allocations'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle',
            borderWidth: 0
        },
        series: [{
            name: 'Allocations',
            data: categories.map(function(cat) {
                return genInfo[cat].length;
            }),
            point: {
              events: {
                click: function(event) { showTable(this.objs); }
              }
            }
        }]
    });
  };

  function readHeap(file) {
    var reader = new FileReader();

    reader.onloadend = function(evt) {
      if (evt.target.readyState == FileReader.DONE) {
        $("#instructions").hide();
        var lines = evt.target.result.split("\n");

        lines.forEach(function(line, ind) {
            if (line.length > 0) {
              var obj = JSON.parse(line);
              objIndex[obj.address] = ind;
              objects.push(obj);
            }
        });
        var typeInfo = objectsByType(objects);
        plotTypes($('#type-info'), typeInfo);

        var genInfo = objectsByGeneration(objects);
        plotGeneration($('#generation-info'), genInfo);

        console.log("done");
      }
    };

    reader.readAsText(file);
  };

document.querySelector('.readButton').addEventListener('click', function(e) {
    readHeap(document.getElementById('file').files[0]);
    }, false);

$(function () {
    // Make monochrome colors and set them as default for all pies
    Highcharts.getOptions().plotOptions.pie.colors = (function () {
        var colors = [],
            base = Highcharts.getOptions().colors[0],
            i;

        for (i = 0; i < 10; i += 1) {
            // Start out with a darkened base color (negative brighten), and end
            // up with a much brighter color
            colors.push(Highcharts.Color(base).brighten((i - 3) / 7).get());
        }
        return colors;
    }());

});
</script>
</body>
</html>
